<!--
 Copyright 2024 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/figma-plugin-ds.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/canvaskit-wasm/bin/canvaskit.js"></script>
</head>

<!-- BEGIN OF SHADER PLUGIN UI -->
<div class="page-padding-large">
    <div style=" justify-content: center; align-items: flex-start; gap: 16px; display: inline-flex;">
        <div>
            <canvas id="shaderPreview" width="256px" height="256px" style="border: 1px black solid" />
        </div>
        <div style="display:flex; flex-wrap: wrap; overflow-y: auto; gap: 10px">
            <div class="button button--primary" onclick="loadShaderCode('mesh2d')">Mesh 2D</div>
            <div class="button button--primary" onclick="loadShaderCode('static_fence_mesh')">Static Fence Mesh</div>
            <div class="button button--primary" onclick="loadShaderCode('static_mesh2d')">Static Mesh 2D</div>
            <div class="button button--primary" onclick="loadShaderCode('static_dots')">Static Dots</div>
            <div class="button button--primary" onclick="loadShaderCode('noisy_polka_dots')">Noisy Polka Dots</div>
            <div class="button button--primary" onclick="loadShaderCode('gradient_flow')">Gradient Flow</div>
            <div class="button button--primary" onclick="loadShaderCode('rainbow')">Rainbow</div>
            <div class="button button--primary" onclick="loadShaderCode('road')">Road</div>
            <div class="button button--primary" onclick="loadShaderCode('road_with_scene')">Road with Scene</div>
            <div class="button button--primary" onclick="clearShaderCode()">Custom Shader</div>
        </div>
    </div>

    <div style="margin-top: 16px; display: flex">
        <textarea id="shaderCodeInput" name="shaderCodeInput" style="width: 100%;" rows="12"
            placeholder="Enter your shader code"></textarea>
    </div>

    <div style="margin-top: 16px;">
        <div>Uniforms:</div>
        <div id="uniforms" style="border: 2px black solid;">
            <div>uniform float3 iResolution;</div>
            <div>uniform float iTime;</div>
        </div>
    </div>

    <div class="container" style="margin-top: 16px;">
        <button id="previewShaderButton" class="styled-button" style="width: 160px;"
            onclick="runShader()">Preview</button>
        <button id="insertImageButton" class="styled-button" style="width: 160px;" onclick="runShader()">Insert Running
            Shader</button>
    </div>

    <div style="margin-top: 16px">
        Shader examples are from:
        <a target="_blank" href="https://shaders.skia.org/">https://shaders.skia.org/</a> and <a target="_blank"
            href="https://shadertoy.com">https://shadertoy.com</a>
    </div>

    <div style="margin-top: 4px">
        This tool is developed using Skia CanvasKit, please use
        <a target="_blank" href="https://shaders.skia.org/">https://shaders.skia.org/</a> to debug.
    </div>
</div>
<!-- END OF SHADER PLUGIN UI -->

<script>
    let canvas = document.getElementById("shaderPreview");
    let shaderCodeInput = document.getElementById("shaderCodeInput");

    let insertButton = document.getElementById("insertImageButton");
    let currentShader = null;

    function clearShaderCode() {
        shaderCodeInput.value = "";
        currentShader = null;
    }

    function loadShaderCode(shader) {
        parent.postMessage({
            pluginMessage: {
                msg: 'loadShaderCode',
                shader: shader,
            }
        }, '*');
    }

    async function runShader() {
        CanvasKitInit({
            locateFile: (file) =>
                "https://unpkg.com/canvaskit-wasm@latest/bin/" + file,
        }).then((CanvasKit) => {
            // Revisied from skia playground https://shaders.skia.org/
            const shaderWidth = 256;
            const shaderHeight = 256;

            let surface = CanvasKit.MakeCanvasSurface(canvas.id);
            if (!surface) {
                throw "Could not make surface";
            }
            const skcanvas = surface.getCanvas();
            const paint = new CanvasKit.Paint();
            const startTimeMs = Date.now();
            let mouseClickX = 0;
            let mouseClickY = 0;
            let mouseDragX = 0;
            let mouseDragY = 0;
            let lastMousePressure = 0;

            const prog = `
// Inputs supplied by shaders.skia.org:
uniform float3 iResolution;      // Viewport resolution (pixels)
uniform float  iTime;            // Shader playback time (s)
uniform float4 iMouse;           // Mouse drag pos=.xy Click pos=.zw (pixels)
` + shaderCodeInput.value;

            currentShader = prog;

            const effect = CanvasKit.RuntimeEffect.Make(prog);

            function drawFrame(canvas) {
                canvas.clear();
                const iTime = (Date.now() - startTimeMs) / 1000;
                const uniforms = [
                    shaderWidth,
                    shaderHeight,
                    1, // iResolution
                    iTime, // iTime
                    mouseClickX,
                    mouseClickY,
                    mouseDragX,
                    mouseDragY, // iMouse
                ];
                const shader = effect.makeShader(uniforms);
                if (!shader) {
                    throw "Could not make shader";
                }
                paint.setShader(shader);
                skcanvas.drawPaint(paint);
                shader.delete();

                surface.requestAnimationFrame(drawFrame);
            }
            surface.requestAnimationFrame(drawFrame);

            canvas.addEventListener("pointermove", (e) => {
                if (e.pressure && !lastMousePressure) {
                    mouseClickX = e.offsetX;
                    mouseClickY = e.offsetY;
                }
                lastMousePressure = e.pressure;
                if (!e.pressure) {
                    return;
                }
                mouseDragX = e.offsetX;
                mouseDragY = e.offsetY;
            });

            insertButton.onclick = e => {
                if (currentShader != null) {
                    parent.postMessage({
                        pluginMessage: {
                            msg: 'setShader',
                            shader: currentShader,
                        }
                    }, '*');
                } else {
                    console.error("There is no shader running....");
                }

                const skImage = surface.makeImageSnapshot();
                if (skImage != null) {
                    parent.postMessage({
                        pluginMessage: {
                            msg: 'insertImage',
                            imageBytes: skImage.encodeToBytes(),
                        }
                    }, '*');
                    skImage.delete();
                } else {
                    console.error("There is no image captured...");
                }

            };
        }); ////// END OF CANVAS KIT //////
    }

    loadShaderCode('mesh2d');

    window.onmessage = async function (event) {
        let msg = event.data.pluginMessage;
        if (msg.msg == 'shaderCode') {
            shaderCodeInput.value = msg.code;
            runShader();
            return;
        }

        if (msg.msg == 'shader-selection-cleared') {
            insertButton.disabled = true;
            return;
        }
        if (msg.msg == "shader-selection") {
            insertButton.disabled = false;
            return;
        }
    }
</script>